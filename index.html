<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singapore PSI Real-time Data</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4CAF50',
                        secondary: '#2196F3',
                        warning: '#FFC107',
                        danger: '#F44336',
                        light: '#F5F5F5',
                        dark: '#212121'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .table-fixed-layout {
                table-layout: fixed;
            }
            .cell-truncate {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .bg-gradient-green {
                background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
            }
            .bg-gradient-blue {
                background: linear-gradient(135deg, #2196F3 0%, #03A9F4 100%);
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-gradient-green text-white shadow-md">
            <div class="container mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="flex items-center mb-4 md:mb-0">
                        <i class="fa fa-leaf text-3xl mr-3"></i>
                        <h1 class="text-2xl md:text-3xl font-bold text-shadow">Singapore PSI Real-time Data</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="refreshBtn" class="bg-white text-primary hover:bg-gray-100 px-4 py-2 rounded-md shadow transition-all flex items-center">
                            <i class="fa fa-refresh mr-2"></i> Refresh Data
                        </button>
                        <div id="autoRefreshContainer" class="flex items-center">
                            <input type="checkbox" id="autoRefresh" class="mr-2 h-4 w-4 accent-primary">
                            <label for="autoRefresh" class="text-sm">Auto-refresh</label>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-8">
            <!-- Status Bar -->
            <div id="statusBar" class="mb-6 p-4 bg-white rounded-md shadow-md flex justify-between items-center">
                <div id="lastUpdated" class="text-gray-600">
                    <i class="fa fa-clock-o mr-1"></i> Last updated: Loading...
                </div>
                <div id="apiStatus" class="flex items-center">
                    <span class="inline-block w-3 h-3 rounded-full bg-gray-400 mr-2"></span>
                    <span class="text-gray-600">Connecting to API...</span>
                </div>
            </div>

            <!-- API Connection Status Alert -->
            <div id="connectionAlert" class="mb-6 p-4 rounded-md shadow-md hidden">
                <div class="flex items-start">
                    <div id="alertIcon" class="flex-shrink-0 mt-1">
                        <i class="fa fa-info-circle text-blue-500 text-xl"></i>
                    </div>
                    <div class="ml-3">
                        <h3 id="alertTitle" class="text-lg font-medium text-blue-800">Information</h3>
                        <div id="alertMessage" class="mt-1 text-blue-700">
                            This is an information message.
                        </div>
                    </div>
                </div>
            </div>

            <!-- PSI Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-primary">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Overall PSI</h3>
                    <div class="flex items-end">
                        <span id="overallPsi" class="text-4xl font-bold text-primary">--</span>
                        <span id="psiStatus" class="ml-2 px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">Good</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Based on 24-hour average</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-secondary">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">PM2.5 Level</h3>
                    <div class="flex items-end">
                        <span id="pm25Level" class="text-4xl font-bold text-secondary">--</span>
                        <span class="ml-1 text-lg text-gray-500">μg/m³</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">24-hour average concentration</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-yellow-500">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Worst Hit Area</h3>
                    <div class="flex items-center">
                        <i class="fa fa-map-marker text-yellow-500 text-xl mr-2"></i>
                        <span id="worstArea" class="text-2xl font-bold text-yellow-500">--</span>
                    </div>
                    <p id="worstAreaValue" class="text-sm text-gray-500 mt-2">PSI: --</p>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">Dominant Pollutant</h3>
                    <div class="flex items-center">
                        <i class="fa fa-info-circle text-purple-500 text-xl mr-2"></i>
                        <span id="dominantPollutant" class="text-2xl font-bold text-purple-500">--</span>
                    </div>
                    <p id="dominantPollutantDesc" class="text-sm text-gray-500 mt-2">--</p>
                </div>
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
                <div class="p-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-700">PSI Readings</h2>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-500 mr-2">Sort by:</span>
                        <select id="sortSelect" class="text-sm border border-gray-300 rounded-md px-2 py-1">
                            <option value="parameter">Parameter</option>
                            <option value="national">National</option>
                            <option value="central">Central</option>
                            <option value="south">South</option>
                            <option value="east">East</option>
                            <option value="west">West</option>
                            <option value="north">North</option>
                        </select>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table id="psiTable" class="min-w-full divide-y divide-gray-200 table-fixed-layout">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">Parameter</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">National</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">Central</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">South</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">East</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">West</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">North</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/14">Health Effects</th>
                            </tr>
                        </thead>
                        <tbody id="psiTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Table rows will be dynamically generated here -->
                            <tr>
                                <td colspan="8" class="px-6 py-4 text-center text-gray-500">Loading data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">PSI Levels by Region</h2>
                    <div class="h-80">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Pollutant Levels</h2>
                    <div class="h-80">
                        <canvas id="pollutantChart"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6">
            <div class="container mx-auto px-4">
                <div class="flex flex-col md:flex-row justify-between items-center">
                    <div class="mb-4 md:mb-0">
                        <p class="text-sm">Data source: <a href="https://data.gov.sg" target="_blank" class="text-primary hover:underline">data.gov.sg</a></p>
                        <p class="text-xs text-gray-400 mt-1">API: <a href="https://api.data.gov.sg/v1/environment/psi" target="_blank" class="text-gray-300 hover:underline">https://api.data.gov.sg/v1/environment/psi</a></p>
                    </div>
                    <div class="text-sm text-gray-400">
                        <p id="footerLastUpdated">Last updated: Loading...</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
            <p class="text-gray-700">Loading data...</p>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://api.data.gov.sg/v1/environment/psi';
        const AUTO_REFRESH_INTERVAL = 60000; // 1 minute in milliseconds
        const API_REQUEST_TIMEOUT = 15000; // 15 seconds
        
        // DOM Elements
        const psiTableBody = document.getElementById('psiTableBody');
        const lastUpdatedEl = document.getElementById('lastUpdated');
        const footerLastUpdatedEl = document.getElementById('footerLastUpdated');
        const apiStatusEl = document.getElementById('apiStatus');
        const refreshBtn = document.getElementById('refreshBtn');
        const autoRefreshCheckbox = document.getElementById('autoRefresh');
        const loadingModal = document.getElementById('loadingModal');
        const sortSelect = document.getElementById('sortSelect');
        const connectionAlert = document.getElementById('connectionAlert');
        const alertIcon = document.getElementById('alertIcon');
        const alertTitle = document.getElementById('alertTitle');
        const alertMessage = document.getElementById('alertMessage');
        
        // Summary Cards
        const overallPsiEl = document.getElementById('overallPsi');
        const psiStatusEl = document.getElementById('psiStatus');
        const pm25LevelEl = document.getElementById('pm25Level');
        const worstAreaEl = document.getElementById('worstArea');
        const worstAreaValueEl = document.getElementById('worstAreaValue');
        const dominantPollutantEl = document.getElementById('dominantPollutant');
        const dominantPollutantDescEl = document.getElementById('dominantPollutantDesc');
        
        // Charts
        let regionChart = null;
        let pollutantChart = null;
        
        // Auto-refresh interval ID
        let autoRefreshIntervalId = null;
        
        // Parameter descriptions for better readability
        const parameterDescriptions = {
            'o3_sub_index': 'Ozone Sub-index',
            'pm10_sub_index': 'PM10 Sub-index',
            'pm25_sub_index': 'PM2.5 Sub-index',
            'co_sub_index': 'Carbon Monoxide Sub-index',
            'so2_sub_index': 'Sulphur Dioxide Sub-index',
            'no2_sub_index': 'Nitrogen Dioxide Sub-index',
            'psi_twenty_four_hourly': '24-hour PSI',
            'pm10_twenty_four_hourly': '24-hour PM10',
            'pm25_twenty_four_hourly': '24-hour PM2.5',
            'so2_twenty_four_hourly': '24-hour SO2',
            'co_twenty_four_hourly': '24-hour CO',
            'o3_twenty_four_hourly': '24-hour Ozone',
            'no2_one_hour_max': '1-hour Max NO2'
        };
        
        // Pollutant descriptions
        const pollutantDescriptions = {
            'o3': 'Ozone',
            'pm10': 'Particulate Matter (PM10)',
            'pm25': 'Particulate Matter (PM2.5)',
            'co': 'Carbon Monoxide',
            'so2': 'Sulphur Dioxide',
            'no2': 'Nitrogen Dioxide'
        };
        
        // PSI status categories and colors based on Singapore NEA standards
        const psiStatusCategories = [
            { 
                min: 0, 
                max: 50, 
                status: 'Good', 
                color: 'bg-green-100 text-green-800',
                healthEffects: 'Normal activities for everyone',
                advisory: 'No restrictions needed'
            },
            { 
                min: 51, 
                max: 100, 
                status: 'Moderate', 
                color: 'bg-yellow-100 text-yellow-800',
                healthEffects: 'Normal activities for everyone',
                advisory: 'No restrictions needed'
            },
            { 
                min: 101, 
                max: 200, 
                status: 'Unhealthy', 
                color: 'bg-orange-100 text-orange-800',
                healthEffects: 'Everyone may begin to experience health effects',
                advisory: 'Healthy persons: Reduce prolonged or strenuous outdoor physical exertion. Elderly, pregnant women & children: Minimise prolonged or strenuous outdoor physical exertion. Persons with chronic lung disease or heart disease: Avoid prolonged or strenuous outdoor physical exertion.'
            },
            { 
                min: 201, 
                max: 300, 
                status: 'Very Unhealthy', 
                color: 'bg-red-100 text-red-800',
                healthEffects: 'More may experience more serious health effects',
                advisory: 'Healthy persons: Avoid prolonged or strenuous outdoor physical exertion. Elderly, pregnant women & children: Minimise outdoor activities. Persons with chronic lung disease or heart disease: Avoid outdoor activities.'
            },
            { 
                min: 301, 
                max: 500, 
                status: 'Hazardous', 
                color: 'bg-purple-100 text-purple-800',
                healthEffects: 'Serious health effects for everyone',
                advisory: 'Healthy persons: Minimise outdoor activities. Elderly, pregnant women & children: Avoid outdoor activities. persons with chronic lung disease or heart disease: Avoid outdoor activities.'
            }
        ];
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Load data on page load
            fetchPsiData();
            
            // Add event listeners
            refreshBtn.addEventListener('click', fetchPsiData);
            autoRefreshCheckbox.addEventListener('change', toggleAutoRefresh);
            sortSelect.addEventListener('change', sortTable);
            
            // Disable auto-refresh by default
            autoRefreshCheckbox.checked = false;
            
            // Show initial information about data loading
            showAlert('info', 'Information', 'Loading the latest air quality data. This may take a few seconds...');
        });
        
        // Fetch PSI data from the API
        async function fetchPsiData() {
            showLoading();
            setApiStatus('Connecting to API...', 'gray');
            hideAlert();
            
            try {
                // Set timeout for API request
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_REQUEST_TIMEOUT);
                
                showAlert('info', 'Connecting', 'Establishing connection to the PSI data API...');
                
                const response = await fetch(API_URL, { signal: controller.signal });
                
                // Clear timeout
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    showAlert('error', 'API Request Failed', `Server responded with status: ${response.status} ${response.statusText}`);
                    throw new Error(`API request failed with status: ${response.status}`);
                }
                
                showAlert('success', 'Connection Established', 'Successfully connected to the API. Retrieving data...');
                
                const data = await response.json();
                
                // Verify data structure before processing
                if (!data || !data.items || !Array.isArray(data.items) || data.items.length === 0) {
                    showAlert('warning', 'Data Format Warning', 'The API returned data in an unexpected format. Using mock data instead.');
                    throw new Error('Invalid data structure received from API');
                }
                
                processPsiData(data);
                setApiStatus('Connected', 'green');
                showAlert('success', 'Data Loaded Successfully', 'The latest air quality data has been loaded and displayed.');
                
            } catch (error) {
                console.error('Error fetching PSI data:', error);
                
                // Show appropriate error message based on error type
                if (error.name === 'AbortError') {
                    setApiStatus('Request timed out', 'red');
                    showAlert('error', 'Connection Timeout', `The request to the API timed out after ${API_REQUEST_TIMEOUT/1000} seconds. Please check your internet connection and try again.`);
                } else if (error.message.includes('Failed to fetch')) {
                    setApiStatus('Network error', 'red');
                    showAlert('error', 'Network Error', 'Failed to connect to the API. Please check your internet connection and try again.');
                } else {
                    setApiStatus('Connection failed', 'red');
                    showAlert('error', 'Data Error', `Failed to load data: ${error.message}. Using mock data instead.`);
                }
                
                // Load mock data
                loadMockData();
                
            } finally {
                hideLoading();
            }
        }
        
        // Show alert message
        function showAlert(type, title, message) {
            // Set alert type styles
            let bgColor, textColor, iconClass;
            
            switch (type) {
                case 'success':
                    bgColor = 'bg-green-50';
                    textColor = 'text-green-800';
                    iconClass = 'fa-check-circle text-green-500';
                    break;
                case 'error':
                    bgColor = 'bg-red-50';
                    textColor = 'text-red-800';
                    iconClass = 'fa-exclamation-circle text-red-500';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50';
                    textColor = 'text-yellow-800';
                    iconClass = 'fa-exclamation-triangle text-yellow-500';
                    break;
                case 'info':
                default:
                    bgColor = 'bg-blue-50';
                    textColor = 'text-blue-800';
                    iconClass = 'fa-info-circle text-blue-500';
            }
            
            // Set alert content
            connectionAlert.className = `mb-6 p-4 rounded-md shadow-md ${bgColor}`;
            alertIcon.innerHTML = `<i class="fa ${iconClass} text-xl"></i>`;
            alertTitle.className = `text-lg font-medium ${textColor}`;
            alertTitle.textContent = title;
            alertMessage.className = `mt-1 ${textColor}`;
            alertMessage.textContent = message;
            
            // Show alert
            connectionAlert.classList.remove('hidden');
        }
        
        // Hide alert message
        function hideAlert() {
            connectionAlert.classList.add('hidden');
        }
        
        // Load mock data when API is unavailable
        function loadMockData() {
            showAlert('warning', 'Using Mock Data', 'Due to API connection issues, the application is showing mock data for demonstration purposes.');
            
            const mockData = {
                "items": [
                    {
                        "timestamp": "2025-10-06T12:00:00+08:00",
                        "update_timestamp": "2025-10-06T12:46:03+08:00",
                        "readings": {
                            "o3_sub_index": {
                                "national": 32,
                                "central": 30,
                                "south": 35,
                                "east": 28,
                                "west": 38,
                                "north": 31
                            },
                            "pm10_sub_index": {
                                "national": 45,
                                "central": 42,
                                "south": 48,
                                "east": 40,
                                "west": 50,
                                "north": 43
                            },
                            "pm25_sub_index": {
                                "national": 28,
                                "central": 25,
                                "south": 30,
                                "east": 22,
                                "west": 32,
                                "north": 26
                            },
                            "co_sub_index": {
                                "national": 15,
                                "central": 14,
                                "south": 16,
                                "east": 13,
                                "west": 18,
                                "north": 15
                            },
                            "so2_sub_index": {
                                "national": 8,
                                "central": 7,
                                "south": 9,
                                "east": 6,
                                "west": 10,
                                "north": 7
                            },
                            "no2_sub_index": {
                                "national": 12,
                                "central": 11,
                                "south": 13,
                                "east": 10,
                                "west": 15,
                                "north": 12
                            },
                            "psi_twenty_four_hourly": {
                                "national": 45,
                                "central": 42,
                                "south": 48,
                                "east": 40,
                                "west": 50,
                                "north": 43
                            },
                            "pm10_twenty_four_hourly": {
                                "national": 55,
                                "central": 52,
                                "south": 58,
                                "east": 50,
                                "west": 60,
                                "north": 53
                            },
                            "pm25_twenty_four_hourly": {
                                "national": 35,
                                "central": 32,
                                "south": 38,
                                "east": 28,
                                "west": 40,
                                "north": 33
                            },
                            "so2_twenty_four_hourly": {
                                "national": 10,
                                "central": 9,
                                "south": 11,
                                "east": 8,
                                "west": 12,
                                "north": 9
                            },
                            "co_twenty_four_hourly": {
                                "national": 0.5,
                                "central": 0.4,
                                "south": 0.5,
                                "east": 0.4,
                                "west": 0.6,
                                "north": 0.5
                            },
                            "o3_twenty_four_hourly": {
                                "national": 65,
                                "central": 62,
                                "south": 68,
                                "east": 60,
                                "west": 70,
                                "north": 63
                            },
                            "no2_one_hour_max": {
                                "national": 25,
                                "central": 23,
                                "south": 27,
                                "east": 22,
                                "west": 30,
                                "north": 24
                            }
                        }
                    }
                ],
                "region_metadata": [
                    {
                        "name": "national",
                        "label_location": {
                            "latitude": 1.35735,
                            "longitude": 103.8198
                        }
                    },
                    {
                        "name": "central",
                        "label_location": {
                            "latitude": 1.3521,
                            "longitude": 103.8198
                        }
                    },
                    {
                        "name": "east",
                        "label_location": {
                            "latitude": 1.3521,
                            "longitude": 103.9198
                        }
                    },
                    {
                        "name": "west",
                        "label_location": {
                            "latitude": 1.3521,
                            "longitude": 103.7198
                        }
                    },
                    {
                        "name": "north",
                        "label_location": {
                            "latitude": 1.4521,
                            "longitude": 103.8198
                        }
                    },
                    {
                        "name": "south",
                        "label_location": {
                            "latitude": 1.2521,
                            "longitude": 103.8198
                        }
                    }
                ]
            };
            
            processPsiData(mockData);
        }
        
        // Process the PSI data and update the UI
        function processPsiData(data) {
            try {
                // Check if data is from v1 API
                if (data.items && Array.isArray(data.items) && data.items.length > 0) {
                    // Process v1 API response
                    const latestReading = data.items[data.items.length - 1];
                    const timestamp = new Date(latestReading.timestamp);
                    
                    // Update last updated time
                    const formattedTime = formatDateTime(timestamp);
                    lastUpdatedEl.innerHTML = `<i class="fa fa-clock-o mr-1"></i> Last updated: ${formattedTime}`;
                    footerLastUpdatedEl.textContent = `Last updated: ${formattedTime}`;
                    
                    // Extract readings
                    const readings = latestReading.readings;
                    
                    // Verify readings data exists
                    if (!readings) {
                        throw new Error('No readings data found in the response');
                    }
                    
                    // Update summary cards
                    updateSummaryCards(readings);
                    
                    // Generate table rows
                    generateTableRows(readings);
                    
                    // Update charts
                    updateCharts(readings);
                } else if (data.code === 0 && data.data && data.data.items) {
                    // Process v2 API response (for backward compatibility)
                    const items = data.data.items;
                    if (items.length > 0) {
                        const latestReading = items[items.length - 1];
                        const timestamp = new Date(latestReading.timestamp);
                        
                        // Update last updated time
                        const formattedTime = formatDateTime(timestamp);
                        lastUpdatedEl.innerHTML = `<i class="fa fa-clock-o mr-1"></i> Last updated: ${formattedTime}`;
                        footerLastUpdatedEl.textContent = `Last updated: ${formattedTime}`;
                        
                        // Extract readings
                        const readings = latestReading.readings;
                        
                        // Update summary cards
                        updateSummaryCards(readings);
                        
                        // Generate table rows
                        generateTableRows(readings);
                        
                        // Update charts
                        updateCharts(readings);
                    } else {
                        throw new Error('No data available in the response');
                    }
                } else {
                    throw new Error('Invalid data format received from API');
                }
            } catch (error) {
                console.error('Error processing data:', error);
                displayError(`Failed to process data: ${error.message}`);
                showAlert('error', 'Data Processing Error', `Failed to process the received data: ${error.message}`);
            }
        }
        
        // Update summary cards with key information
        function updateSummaryCards(readings) {
            try {
                // Overall PSI (24-hour)
                if (readings.psi_twenty_four_hourly && readings.psi_twenty_four_hourly.national !== undefined) {
                    const overallPsi = readings.psi_twenty_four_hourly.national;
                    overallPsiEl.textContent = overallPsi;
                    
                    // Get PSI status
                    const psiStatus = getPsiStatus(overallPsi);
                    psiStatusEl.textContent = psiStatus.status;
                    psiStatusEl.className = `ml-2 px-2 py-1 text-xs rounded-full ${psiStatus.color}`;
                } else {
                    overallPsiEl.textContent = 'N/A';
                    psiStatusEl.textContent = 'Unavailable';
                    psiStatusEl.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800';
                }
                
                // PM2.5 Level (24-hour)
                if (readings.pm25_twenty_four_hourly && readings.pm25_twenty_four_hourly.national !== undefined) {
                    const pm25Level = readings.pm25_twenty_four_hourly.national;
                    pm25LevelEl.textContent = pm25Level;
                } else {
                    pm25LevelEl.textContent = 'N/A';
                }
                
                // Worst hit area
                if (readings.psi_twenty_four_hourly) {
                    const worstArea = findWorstHitArea(readings.psi_twenty_four_hourly);
                    worstAreaEl.textContent = formatAreaName(worstArea.area);
                    worstAreaValueEl.textContent = `PSI: ${worstArea.value}`;
                } else {
                    worstAreaEl.textContent = 'N/A';
                    worstAreaValueEl.textContent = 'PSI: Unavailable';
                }
                
                // Dominant pollutant
                const dominantPollutant = findDominantPollutant(readings);
                if (dominantPollutant.pollutant) {
                    dominantPollutantEl.textContent = pollutantDescriptions[dominantPollutant.pollutant] || dominantPollutant.pollutant;
                    dominantPollutantDescEl.textContent = `Highest in ${formatAreaName(dominantPollutant.area)}: ${dominantPollutant.value}`;
                } else {
                    dominantPollutantEl.textContent = 'N/A';
                    dominantPollutantDescEl.textContent = 'Data unavailable';
                }
            } catch (error) {
                console.error('Error updating summary cards:', error);
                showAlert('warning', 'Data Display Warning', 'Some summary data could not be displayed due to missing information.');
            }
        }
        
        // Generate table rows from readings
        function generateTableRows(readings) {
            try {
                // Clear existing rows
                psiTableBody.innerHTML = '';
                
                // Get the 12 required parameters
                const parameters = [
                    'o3_sub_index', 'pm10_sub_index', 'pm25_sub_index', 
                    'co_sub_index', 'so2_sub_index', 'no2_sub_index',
                    'psi_twenty_four_hourly', 'pm10_twenty_four_hourly', 
                    'pm25_twenty_four_hourly', 'so2_twenty_four_hourly',
                    'co_twenty_four_hourly', 'o3_twenty_four_hourly'
                ];
                
                // Check if there are any readings available
                const hasReadings = parameters.some(param => readings[param] !== undefined);
                
                if (!hasReadings) {
                    throw new Error('No readings data available to display');
                }
                
                // Create a row for each parameter
                parameters.forEach(param => {
                    if (readings[param]) {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        
                        // Parameter name
                        const paramCell = document.createElement('td');
                        paramCell.className = 'px-6 py-4 whitespace-nowrap font-medium text-gray-900';
                        paramCell.textContent = parameterDescriptions[param] || param;
                        row.appendChild(paramCell);
                        
                        // Regions data
                        const regions = ['national', 'central', 'south', 'east', 'west', 'north'];
                        regions.forEach(region => {
                            const cell = document.createElement('td');
                            cell.className = 'px-6 py-4 whitespace-nowrap text-gray-700';
                            
                            // Get the value
                            const value = readings[param][region];
                            
                            // Format the value
                            if (value === null || value === undefined) {
                                cell.textContent = 'N/A';
                                cell.className += ' text-gray-400';
                            } else {
                                cell.textContent = value;
                                
                                // Highlight extreme values for PSI
                                if (param === 'psi_twenty_four_hourly') {
                                    const status = getPsiStatus(value);
                                    if (status.status === 'Unhealthy' || status.status === 'Very Unhealthy' || 
                                        status.status === 'Hazardous') {
                                        cell.className += ' font-bold';
                                        cell.classList.add(...status.color.split(' '));
                                    }
                                }
                            }
                            
                            row.appendChild(cell);
                        });
                        
                        // Status column (only for PSI)
                        const statusCell = document.createElement('td');
                        statusCell.className = 'px-6 py-4 whitespace-nowrap';
                        
                        if (param === 'psi_twenty_four_hourly') {
                            const nationalValue = readings[param].national;
                            if (nationalValue !== undefined && nationalValue !== null) {
                                const status = getPsiStatus(nationalValue);
                                const statusSpan = document.createElement('span');
                                statusSpan.className = `px-2 py-1 text-xs rounded-full ${status.color}`;
                                statusSpan.textContent = status.status;
                                statusCell.appendChild(statusSpan);
                            } else {
                                statusCell.textContent = 'N/A';
                                statusCell.className += ' text-gray-400';
                            }
                        }
                        
                        row.appendChild(statusCell);
                        
                        // Health Effects column (only for PSI)
                        const healthCell = document.createElement('td');
                        healthCell.className = 'px-6 py-4 whitespace-nowrap';
                        
                        if (param === 'psi_twenty_four_hourly') {
                            const nationalValue = readings[param].national;
                            if (nationalValue !== undefined && nationalValue !== null) {
                                const status = getPsiStatus(nationalValue);
                                
                                // Create health effects cell with tooltip
                                const healthEffectsDiv = document.createElement('div');
                                healthEffectsDiv.className = 'flex items-center';
                                
                                const healthEffectsText = document.createElement('span');
                                healthEffectsText.textContent = status.healthEffects;
                                healthEffectsText.className = 'text-sm';
                                
                                const tooltipIcon = document.createElement('i');
                                tooltipIcon.className = 'fa fa-info-circle ml-2 text-blue-500 cursor-help';
                                
                                // Create tooltip
                                const tooltip = document.createElement('div');
                                tooltip.className = 'hidden absolute z-10 mt-2 p-3 bg-gray-800 text-white text-xs rounded-md shadow-lg w-64';
                                tooltip.innerHTML = `
                                    <div class="font-semibold mb-1">Health Advisory</div>
                                    <div>${status.advisory}</div>
                                ` ;
                                
                                // Add event listeners for tooltip
                                tooltipIcon.addEventListener('mouseenter', () => {
                                    tooltip.classList.remove('hidden');
                                });
                                
                                tooltipIcon.addEventListener('mouseleave', () => {
                                    tooltip.classList.add('hidden');
                                });
                                
                                healthEffectsDiv.appendChild(healthEffectsText);
                                healthEffectsDiv.appendChild(tooltipIcon);
                                healthEffectsDiv.appendChild(tooltip);
                                
                                // Add relative positioning to parent for tooltip
                                healthEffectsDiv.style.position = 'relative';
                                
                                healthCell.appendChild(healthEffectsDiv);
                            } else {
                                healthCell.textContent = 'N/A';
                                healthCell.className += ' text-gray-400';
                            }
                        }
                        
                        row.appendChild(healthCell);
                        psiTableBody.appendChild(row);
                    }
                });
            } catch (error) {
                console.error('Error generating table rows:', error);
                displayError(`Failed to generate table: ${error.message}`);
            }
        }
        
        // Update charts with current data
        function updateCharts(readings) {
            try {
                // Update region chart (PSI levels by region)
                if (readings.psi_twenty_four_hourly) {
                    updateRegionChart(readings.psi_twenty_four_hourly);
                } else {
                    console.warn('PSI data not available for region chart');
                    showAlert('warning', 'Chart Warning', 'PSI data is not available to display the region chart.');
                }
                
                // Update pollutant chart (PM2.5 levels)
                if (readings.pm25_twenty_four_hourly) {
                    updatePollutantChart(readings.pm25_twenty_four_hourly);
                } else {
                    console.warn('PM2.5 data not available for pollutant chart');
                    showAlert('warning', 'Chart Warning', 'PM2.5 data is not available to display the pollutant chart.');
                }
            } catch (error) {
                console.error('Error updating charts:', error);
                showAlert('error', 'Chart Error', `Failed to update charts: ${error.message}`);
            }
        }
        
        // Update region chart
        function updateRegionChart(psiData) {
            const ctx = document.getElementById('regionChart').getContext('2d');
            
            // Extract data
            const regions = ['central', 'south', 'east', 'west', 'north'];
            const labels = regions.map(formatAreaName);
            const data = regions.map(region => psiData[region] || 0);
            
            // Determine colors based on PSI levels
            const backgroundColor = data.map(value => {
                const status = getPsiStatus(value);
                return status.color.split(' ')[0].replace('bg-', 'rgba(') + ', 0.6)';
            });
            
            // Destroy existing chart if it exists
            if (regionChart) {
                regionChart.destroy();
            }
            
            // Create new chart
            regionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'PSI Level',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'PSI Value'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const value = context.raw;
                                    const status = getPsiStatus(value);
                                    return `Status: ${status.status}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update pollutant chart
        function updatePollutantChart(pm25Data) {
            const ctx = document.getElementById('pollutantChart').getContext('2d');
            
            // Extract data
            const regions = ['central', 'south', 'east', 'west', 'north'];
            const labels = regions.map(formatAreaName);
            const data = regions.map(region => pm25Data[region] || 0);
            
            // Destroy existing chart if it exists
            if (pollutantChart) {
                pollutantChart.destroy();
            }
            
            // Create new chart
            pollutantChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'PM2.5 (μg/m³)',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            ticks: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
        
        // Find the worst hit area (highest PSI)
        function findWorstHitArea(psiData) {
            const regions = ['central', 'south', 'east', 'west', 'north'];
            let worstArea = 'national';
            let worstValue = psiData.national || 0;
            
            regions.forEach(region => {
                if (psiData[region] !== undefined && psiData[region] > worstValue) {
                    worstValue = psiData[region];
                    worstArea = region;
                }
            });
            
            return { area: worstArea, value: worstValue };
        }
        
        // Find the dominant pollutant (highest sub-index)
        function findDominantPollutant(readings) {
            const pollutants = ['o3_sub_index', 'pm10_sub_index', 'pm25_sub_index', 
                               'co_sub_index', 'so2_sub_index', 'no2_sub_index'];
            
            let dominantPollutant = '';
            let dominantValue = 0;
            let dominantArea = 'national';
            
            pollutants.forEach(pollutant => {
                if (readings[pollutant]) {
                    const regions = ['national', 'central', 'south', 'east', 'west', 'north'];
                    
                    regions.forEach(region => {
                        const value = readings[pollutant][region];
                        
                        if (value !== undefined && value > dominantValue) {
                            dominantValue = value;
                            dominantPollutant = pollutant.replace('_sub_index', '');
                            dominantArea = region;
                        }
                    });
                }
            });
            
            return { pollutant: dominantPollutant, value: dominantValue, area: dominantArea };
        }
        
        // Get PSI status category
        function getPsiStatus(value) {
            if (value === undefined || value === null) {
                return {
                    status: 'Unknown',
                    color: 'bg-gray-100 text-gray-800',
                    healthEffects: 'Data unavailable',
                    advisory: 'No data available for health advisory'
                };
            }
            
            for (const category of psiStatusCategories) {
                if (value >= category.min && value <= category.max) {
                    return category;
                }
            }
            return psiStatusCategories[psiStatusCategories.length - 1]; // Default to extreme
        }
        
        // Format date and time
        function formatDateTime(date) {
            if (!date || isNaN(date.getTime())) {
                return 'Unknown time';
            }
            
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false,
                timeZoneName: 'short'
            };
            return date.toLocaleString('en-SG', options);
        }
        
        // Format area name for display
        function formatAreaName(area) {
            if (!area) return 'Unknown';
            return area.charAt(0).toUpperCase() + area.slice(1);
        }
        
        // Set API status indicator
        function setApiStatus(message, color) {
            let bgColor;
            switch (color) {
                case 'green':
                    bgColor = 'bg-green-500';
                    break;
                case 'red':
                    bgColor = 'bg-red-500';
                    break;
                case 'yellow':
                    bgColor = 'bg-yellow-500';
                    break;
                default:
                    bgColor = 'bg-gray-400';
            }
            
            apiStatusEl.innerHTML = `
                <span class="inline-block w-3 h-3 rounded-full ${bgColor} mr-2"></span>
                <span class="text-gray-600">${message}</span>
            ` ;
        }
        
        // Show loading modal
        function showLoading() {
            loadingModal.classList.remove('hidden');
        }
        
        // Hide loading modal
        function hideLoading() {
            loadingModal.classList.add('hidden');
        }
        
        // Display error message in table
        function displayError(message) {
            psiTableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="px-6 py-4 text-center text-red-500">
                        <i class="fa fa-exclamation-circle mr-2"></i>${message}
                    </td>
                </tr>
            ` ;
        }
        
        // Toggle auto-refresh
        function toggleAutoRefresh() {
            if (autoRefreshCheckbox.checked) {
                // Start auto-refresh
                autoRefreshIntervalId = setInterval(fetchPsiData, AUTO_REFRESH_INTERVAL);
                refreshBtn.classList.add('animate-pulse-slow');
                showAlert('info', 'Auto-refresh Enabled', 'The application will automatically refresh data every minute.');
            } else {
                // Stop auto-refresh
                clearInterval(autoRefreshIntervalId);
                refreshBtn.classList.remove('animate-pulse-slow');
                showAlert('info', 'Auto-refresh Disabled', 'Automatic data refresh has been stopped.');
            }
        }
        
        // Sort table by selected column
        function sortTable() {
            const sortBy = sortSelect.value;
            
            // Get all table rows
            const rows = Array.from(psiTableBody.querySelectorAll('tr'));
            
            // Sort rows based on selected column
            rows.sort((a, b) => {
                let aValue, bValue;
                
                if (sortBy === 'parameter') {
                    // Sort by parameter name
                    aValue = a.querySelector('td').textContent.toLowerCase();
                    bValue = b.querySelector('td').textContent.toLowerCase();
                } else {
                    // Sort by numeric value in selected column
                    const columns = ['national', 'central', 'south', 'east', 'west', 'north'];
                    const columnIndex = columns.indexOf(sortBy) + 1; // +1 because first column is parameter
                    
                    aValue = parseFloat(a.querySelectorAll('td')[columnIndex].textContent) || 0;
                    bValue = parseFloat(b.querySelectorAll('td')[columnIndex].textContent) || 0;
                }
                
                if (aValue < bValue) return -1;
                if (aValue > bValue) return 1;
                return 0;
            });
            
            // Clear table and re-add sorted rows
            psiTableBody.innerHTML = '';
            rows.forEach(row => psiTableBody.appendChild(row));
        }
    </script>
</body>
</html>
